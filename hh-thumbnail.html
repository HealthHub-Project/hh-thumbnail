<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../hh-icons/hh-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">

<dom-module id="hh-thumbnail">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }

      .container-column {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
        background-color: #252934;
      }

      .flex-child {
        display: flex;
        flex: 1;
      }

      /*prev, next paging*/
      .seriesPaging {
        display: flex;
        flex: 1;
        align-items: center;
        margin: 0 5px 0 5px;
      }

      .pagingIcon {
        padding: 0;
        width: 25px;
        height: 25px;
        color: #4c5667;
      }

      .pagingIcon:hover {
        color: #0087cb;
      }

      /*next paging + setting button*/
      .settingContainer {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /*setting button 사이즈 만큼 밑으로 내려가 center로 잡아줌*/
      #nextImages {
        margin-bottom: 26px;
      }

      /*setting button*/
      .settingIcon {
        padding: 4px;
        width: 26px;
        height: 25px;
        color: #aaaaaa;
      }

      .settingIcon:hover {
        color: #2baab1;
      }

      .container-thumbnail-image {
        width: 100%;
        text-align: center;
        background-color: #252934;
        margin: 25px 0;
      }

      .canvasImage {
        height: 100%;
        width: 100%;
      }
    </style>
    <div class="container-column">
      <div class="flex-child">
        <div class="seriesPaging">
          <paper-icon-button id="prevImages" class="pagingIcon" raised icon="healthhub:filter-left" on-click="prevImages"></paper-icon-button>
          <paper-tooltip for="prevImages" offset="0" animation-delay="0" animation-entry="scale-up-animation" animation-exit="fade-out-animation">prev</paper-tooltip>
        </div>
        <div id="containerThumbnailImage" class="container-thumbnail-image">
          <canvas id="canvasImages" class="canvasImage"></canvas>
        </div>
        <div class="settingContainer">
          <div class="wrap-report-setting" on-click="setThumbnailCell">
            <paper-icon-button id="setThumbnailCell" class="settingIcon" icon="healthhub:settings-view"></paper-icon-button>
            <paper-tooltip for="setThumbnailCell" offset="0" animation-delay="0" animation-entry="scale-up-animation" animation-exit="fade-out-animation">Thumbnail Setting</paper-tooltip>
          </div>
          <div class="seriesPaging">
            <paper-icon-button id="nextImages" class="pagingIcon" raised icon="healthhub:filter-right" on-click="nextImages"></paper-icon-button>
            <paper-tooltip for="nextImages" offset="0" animation-delay="0" animation-entry="scale-up-animation" animation-exit="fade-out-animation">next</paper-tooltip>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    /**
     * `hh-thumbnail`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    (function () {
        let _this;

        window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;

        const type = {
            TOAST: 'toast'
        };

        const msg = {
            NOT_FOUND_ERR: 'Downloading Thumbnail image.'
        };

        // let _firstStart = true;
        let _checkThumbnailCell;

        // 셀 정보
        let Info = function () { };

        // 셀 사이즈
        let _infoSize = {};

        // 썸네일
        let _thumbnail = {};

        let _arrImage = [];

        let _nextImage = false;
        let _prevImage = false;

        let _nextIdx = 0;

        // 업무종류
        // 셀크기 설정
        let e_EditMode_SelectCell = 0;
        // 셀종류 설정
        let e_EditMode_SetPosition = 1;

        // 버튼종류
        // 버튼
        // let e_Button_Button = 0;
        // 라디오버튼
        let e_Button_Radio = 1;

        // 셀 종류
        // None
        let e_CellStyle_None = 0;
        // // New
        // let e_CellStyle_New = 1;
        // // Old
        // let e_CellStyle_Old = 2;
        // // First
        // let e_CellStyle_First = 3;

        // 기본글자
        let m_sBaseText = "혫";

        // Layout 설정 여부
        let _bLayout = false;

        // let _ddpThumbnailLayout;

        // Series 갯수
        let _seriesLen = 0;

        let _workListObjId;

        let _thumbnailCell = false;

        class HhThumbnail extends Polymer.Element {
          static get is() { return 'hh-thumbnail'; }
          static get properties() {
            return {
              prop1: {
                type: String,
                value: 'hh-thumbnail'
              }
            };
          }

            constructor() {
                super();
                _this = this;
            }

            ready() {
                super.ready();

                window.addEventListener('WebComponentsReady', e => {
                    _this.startBody();
                });
            }

            // /**
            //  * function getWorkListNewId
            //  * workList Row 클릭시 Thumbnail 이미지 조회
            //  *
            //  * Create by 김민정 on 2018-05-17 오전 10:18
            //  * @param {}
            //  * @return {}
            //  **/
            // getWorkListNewId(id) {

                // _workListObjId = id;
                //
                // _this.getExamInfo(id).then((resultThumbnail) => {
                //     if(_infoSize.Position !== undefined && resultThumbnail !== undefined && typeof(resultThumbnail.series) != "undefined"){
                //         _seriesLen = resultThumbnail.series.length;
                //         _this.seriesPagingClear();
                //         _this.startBody();
                //         _this.setCellThumbnail(resultThumbnail);
                //     }
                // });

                // _this.getStructStudy(id).then((resultThumbnail) => {
                //     if(_infoSize.Position !== undefined && resultThumbnail !== undefined && typeof(resultThumbnail.series) != "undefined"){
                //         _seriesLen = resultThumbnail.series.length;
                //         _this.seriesPagingClear();
                //         _this.startBody();
                //         _this.setCellThumbnail(resultThumbnail);
                //     }
                // }, (err) => {
                //     console.log(err);
                // });
            // }


            /**
             * function getExamInfo
             * RequestObjectId로 의뢰이미지조회
             *
             * Create by 김민정 on 2019-01-03 오후 2:46
             * @param {} 
             * @return {}
            **/
            getExambyId(id, resultThumbnail) {
                _workListObjId = id;

                if(_infoSize.Position !== undefined && resultThumbnail !== undefined && typeof(resultThumbnail.series) != "undefined"){
                    _seriesLen = resultThumbnail.series.length;
                    _this.seriesPagingClear();
                    _this.startBody();
                    _this.setCellThumbnail(resultThumbnail);
                }
            }

            seriesPagingClear() {
                _arrImage = [];
                _nextIdx = 0;
                _nextImage = false;
                _prevImage = false;
            }

            errorHandler(e) {
                let message = '';
                switch (e.code) {
                    case 22:
                        message = 'QUOTA_EXCEEDED_ERR';
                        break;
                    case 8:
                        message = 'NOT_FOUND_ERR';
                        break;
                    case 18:
                        message = 'SECURITY_ERR';
                        break;
                    case 13:
                        message = 'INVALID_MODIFICATION_ERR';
                        break;
                    //     case FileError.INVALID_STATE_ERR:
                    //         msg = 'INVALID_STATE_ERR';
                    //         break;
                    default:
                        message = 'Unknown Error';
                        break;
                };

                _this.toast(type.TOAST, msg.NOT_FOUND_ERR, true);

            }

            toast(type, msg, isErr) {
                let message = new Object();
                message.type = type;
                message.msg = msg;
                message.isErr = isErr;

                let param = new Object();
                param.detail = message;
                this.dispatchEvent(new CustomEvent('toastEvent', param));
            }

            getStructStudy(studyObjectId) {
                return new Promise(function (resolve, reject) {
                    let url = baseUrl + '/exchange/worklist/struct/study/' + studyObjectId;
                    fetch(url, {
                        method: "GET",
                        headers: {
                            "Authorization": localStorage.getItem("jwt")
                        }
                    }).then(function (response) {
                        if (response.ok && response.status == 200) {
                            response.json().then(function (result) {
                                resolve(result);
                            });
                        }
                        else {
                            reject("message : '" + response.status + "' " + response.statusText);
                        }
                    });
                });
            }

            /**
             * function clearThumbnail
             * Thumbnail 초기화
             *
             * Create by 김민정 on 2018-10-25 오후 4:09
             * @param {}
             * @return {}
             **/
            clearThumbnail() {
                _seriesLen=0;
                _this.startBody();
            }

            startBody() {
                _this.InitializeFunction();
                // _this.InitializeMember();
                _this.InitializeInfo();
                _this.InitializeEvent();

                _this.resizeCanvas();

                _this.drawBoard();
            }

            resizeCanvas() {
                let canvas = _this.$.canvasImages;

                // canvas size로 설정
                // canvas.width = 300;
                // canvas.height = 300;
                //
                // Info.Width = 300;
                // Info.Height = 300;

                // canvas size로 설정
                canvas.width = _this.$.containerThumbnailImage.offsetWidth;
                canvas.height = _this.$.containerThumbnailImage.offsetHeight;

                Info.Width = canvas.width;
                Info.Height = canvas.height;

                _this.setSelectCellBounds();
                _this.setSetPositionCellBounds();
                _this.drawBoard();
            }

            InitializeFunction() {

                // padLeft
                if (!String.prototype.padLeft) {
                    String.prototype.padLeft = function padLeft(nLength, sPadString) {
                        nLength = nLength >> 0;
                        sPadString = String(sPadString || " ");

                        if (this.length > nLength) {
                            return String(this);
                        }
                        else {
                            nLength = nLength - this.length;

                            if (nLength > sPadString.length) {
                                sPadString += sPadString.repeat(nLength / sPadString.length);
                            }// if

                            return sPadString.slice(0, nLength) + String(this);
                        }
                    }// function
                }// if
            }

            InitializeInfo() {

                let canvas = _this.$.canvasImages;

                Info.Context = canvas.getContext("2d");

                // Info.Width = window.innerWidth;
                // Info.Height = window.innerHeight;

                Info.Width = _this.$.containerThumbnailImage.offsetWidth;
                Info.Height = _this.$.containerThumbnailImage.offsetHeight;

                Info.EditMode = e_EditMode_SetPosition;
                _this.InitializeInfoSetPosition();

                if(_checkThumbnailCell !== undefined && _checkThumbnailCell) { // 설정버튼 클릭했을시
                    Info.EditMode = e_EditMode_SelectCell;
                    _this.InitializeInfoSelectCell();
                    _this.InitializeInfoSetPosition();
                }
            }

            InitializeInfoSelectCell() {

                Info.SelectCell = function () { };

                Info.SelectCell.Rows = 10;
                Info.SelectCell.Columns = 10;
                Info.SelectCell.PaddingWidth = -0.5;
                Info.SelectCell.SelectedRow = -1;
                Info.SelectCell.SelectedColumn = -1;
                Info.SelectCell.SelectedIndex = -1;

                Info.SelectCell.BackColor = "rgba(0,0,0,0.8)";
                Info.SelectCell.BorderColor = "rgba(210, 210, 210, 0.7)";
                Info.SelectCell.SelectedBackColor = "rgba(210, 210, 210, 0.2)";
                Info.SelectCell.TextFont = "100px Verdana bold";
                Info.SelectCell.TextColor = "rgba(210, 210, 210, 0.7)";

                Info.SelectCell.Cells = [];
                _this.setSelectCellBounds();
            }

            InitializeInfoSetPosition() {

                let obj = function () { };

                obj.PaddingWidth = 3;

                // 시리즈 갯수 별 layout 지정
                if(_seriesLen === 0){
                    obj.Rows = 2;
                    obj.Columns = 2;
                }
                else {
                    let seriesLayout;

                    for(let rowCol = 1; rowCol <= 10; rowCol++) {
                        let thumbnailLayout = rowCol*rowCol;
                        if(_seriesLen <= thumbnailLayout) {
                            if(rowCol !== 1){
                                seriesLayout = thumbnailLayout / rowCol;
                                break;
                            }
                            else {
                                seriesLayout = rowCol;
                                break;
                            }
                        }
                    }

                    obj.Rows = seriesLayout;
                    obj.Columns = seriesLayout;
                }

                obj.GapHeight = 3;
                obj.ButtonGapWidth = 2;

                obj.Buttons = [];

                obj.Command = "";

                obj.ForeColor = "rgba(210, 210, 210, 0.7)";
                obj.BackColor = "rgba(0,0,0,0.8)";
                obj.BorderColor = "rgba(210, 210, 210, 0.7)";
                obj.SelectedBackColor = "rgba(0,0,0,0.7)";

                obj.TextFont = "12px Verdana";
                obj.TextColor = "rgba(210, 210, 210, 0.7)";

                // obj.Drags = [];
                obj.MouseDragCellIndex = -1;

                obj.Cells = [];

                Info.SetPosition = obj;

                _this.setSetPositionCellBounds();

                for (let i = 0; i < obj.Cells.length; i++) {
                    obj.Cells[i].Command = "";
                    obj.Cells[i].SortNo = 0;
                }// for i
            }

            setSetPositionCheck(sCommand) {

                for (let i = 0; i < Info.SetPosition.Buttons.length; i++) {

                    let obj = Info.SetPosition.Buttons[i];

                    if (obj.Style === e_Button_Radio && obj.Command === sCommand) {
                        obj.Checked = true;
                        Info.SetPosition.Command = sCommand;
                    }// if
                    else {
                        obj.Checked = false;
                    }
                }// for i
            }

            setSetPositionClear() {

                for (let i = 0; i < Info.SetPosition.Cells.length; i++) {
                    let obj = Info.SetPosition.Cells[i];

                    obj.Command = "";
                }// for i

                _this.drawBoard();
            }

            InitializeEvent() {
                window.addEventListener('mousemove', _this.OnMouseMove, false);
                window.addEventListener('mousedown', _this.OnMouseDown, false);
                window.addEventListener('mouseup', _this.OnMouseUp, false);
                window.addEventListener('mousewheel', _this.OnMouseWheel, false);
            }

            drawBoard() {

                Info.Context.clearRect(0, 0, Info.Width, Info.Height);
                Info.Context.fillStyle = "rgba(0,0,0,0.8)";

                Info.Context.fillRect(0, 0, Info.Width, Info.Height);

                if (Info.EditMode === e_EditMode_SelectCell) {
                    _bLayout = false;
                    _this.drawSelectCell();

                }// if
                else if (Info.EditMode === e_EditMode_SetPosition) {
                    _bLayout = true;
                    _this.drawSetPosition();
                }// else if

            }

            drawSelectCell() {

                let nBorderWidth = 1;

                for (let i = 0; i < Info.SelectCell.Cells.length; i++) {

                    let nX = Info.SelectCell.Cells[i].Position.X;
                    let nY = Info.SelectCell.Cells[i].Position.Y;
                    let nW = Info.SelectCell.Cells[i].Size.Width;
                    let nH = Info.SelectCell.Cells[i].Size.Height;

                    // 배경
                    if (Info.SelectCell.Cells[i].Include) {
                        Info.Context.fillStyle = Info.SelectCell.SelectedBackColor;
                    }
                    else {
                        Info.Context.fillStyle = Info.SelectCell.BackColor;
                    }
                    Info.Context.fillRect(nX, nY, nW, nH);
                }// for i

                // 글
                let sText = "".concat(Info.SelectCell.SelectedRow + 1, "X", Info.SelectCell.SelectedColumn + 1);
                Info.Context.beginPath();
                Info.Context.font = Info.SelectCell.TextFont;
                Info.Context.fillStyle = Info.SelectCell.TextColor;
                Info.Context.textAlign = "left";
                Info.Context.textBaseline = "top";

                let nTextW = Info.Context.measureText(sText).width;
                let nTextH = Info.Context.measureText(m_sBaseText).width + Info.Context.measureText(m_sBaseText).width / 2;

                let nTextX = (Info.Width - nTextW) / 2;
                let nTextY = (Info.Height - nTextH) / 2;

                Info.Context.fillText(sText, nTextX, nTextY);

                for (let i = 0; i < Info.SelectCell.Cells.length; i++) {

                    let nX = Info.SelectCell.Cells[i].Position.X;
                    let nY = Info.SelectCell.Cells[i].Position.Y;
                    let nW = Info.SelectCell.Cells[i].Size.Width;
                    let nH = Info.SelectCell.Cells[i].Size.Height;

                    // 줄
                    Info.Context.beginPath();
                    Info.Context.strokeStyle = Info.SelectCell.BorderColor;
                    Info.Context.strokeRect(nX + 0.5, nY + 0.5, nW, nH);
                }// for i

            }

            drawSetPosition() {

                _infoSize.Position = [];

                // Draw Cells
                for (let i = 0; i < Info.SetPosition.Cells.length; i++) {

                    let oCell = Info.SetPosition.Cells[i];

                    let nX = oCell.Position.X;
                    let nY = oCell.Position.Y;
                    let nW = oCell.Size.Width;
                    let nH = oCell.Size.Height;

                    // Cell Position, Size 정보
                    _infoSize.Position.push(oCell);

                    // Border
                    Info.Context.beginPath();
                    Info.Context.strokeStyle = Info.SetPosition.BorderColor;
                    Info.Context.strokeRect(nX + 0.5, nY + 0.5, nW, nH);
                }// for i
            }

            setCellThumbnail(resultThumbnail) {
                let nPos = 0;

                for (let series in resultThumbnail.series) {

                    let oCell = {};

                    if (_infoSize.Position.length > nPos && series !== undefined) {
                        oCell.seriesIdx = parseInt(series);
                        oCell.imageIdx = 0;
                        oCell.lastimageIdx = resultThumbnail.series[series].image.length;

                        let objImg = {};

                        let arrSize = [];

                        for(let img of resultThumbnail.series[series].image) {

                            let imgSize = new Object();

                            imgSize.width = img.width;
                            imgSize.height = img.height;
                            imgSize.size = imgSize.width*imgSize.height;

                            arrSize.push(imgSize);
                        }

                        objImg = arrSize;

                        oCell.imgSize = objImg;

                        _infoSize.Position[nPos].Cell = oCell;
                    }


                    if(_infoSize.Position.length <= nPos){
                        _nextImage = true;

                        oCell.seriesIdx = parseInt(series);
                        oCell.imageIdx = 0;
                        oCell.lastimageIdx = resultThumbnail.series[series].image.length;


                        let objImg = {};

                        let arrSize = [];

                        for(let img of resultThumbnail.series[series].image) {

                            let imgSize = new Object();

                            imgSize.width = img.width;
                            imgSize.height = img.height;
                            imgSize.size = imgSize.width*imgSize.height;

                            arrSize.push(imgSize);
                        }

                        objImg = arrSize;

                        oCell.imgSize = objImg;
                    }

                    _arrImage.push(oCell);

                    nPos++;

                } // for

                _thumbnail = resultThumbnail;

                _this.clearCanvas();
                _this.drawImages();

            }

            // canvas 초기화
            clearCanvas() {
                for (let i in _infoSize.Position){
                    let oCell = _infoSize.Position[i];
                    Info.Context.clearRect(oCell.Position.X+2, oCell.Position.Y+2, oCell.Size.Width-3, oCell.Size.Height-3);
                    _this.setSetPositionClear();
                }
            }

            drawImages() {
                if(_bLayout){
                    for (let series in _thumbnail.series) {
                        let oPos = _infoSize.Position[series];

                        // if(oPos !== undefined && _thumbnail.studies[0].series[oPos.Cell.seriesIdx] !== undefined){
                        if(oPos !== undefined && oPos.Cell !== null) {
                            let img = new Image();
                            let seriesId = _thumbnail.series[oPos.Cell.seriesIdx].seriesInstanceUID;
                            let imageId = _thumbnail.series[oPos.Cell.seriesIdx].image[oPos.Cell.imageIdx].contentID;

                            // 원본 이미지 크기
                            let imgWidth = _thumbnail.series[oPos.Cell.seriesIdx].image[oPos.Cell.imageIdx].width;
                            let imgHeight = _thumbnail.series[oPos.Cell.seriesIdx].image[oPos.Cell.imageIdx].height;

                            // cell 크기
                            let maxWidth = oPos.Size.Width;
                            let maxHeight = oPos.Size.Height;

                            // 사이즈 조정 이미지 크기
                            let resizeWidth;
                            let resizeHeight;

                            // 이미지 비율
                            if (imgWidth > imgHeight) {
                                resizeWidth = maxWidth;
                                resizeHeight = Math.round((imgHeight * resizeWidth) / imgWidth);
                            } else {
                                resizeHeight = maxHeight;
                                resizeWidth = Math.round((imgWidth * resizeHeight) / imgHeight);
                            }

                            // 비율 맞춘 이미지가 클 경우 축소
                            let scaleX = maxWidth / resizeWidth;
                            let scaleY = maxHeight / resizeHeight;

                            let scale = (scaleX < scaleY) ? scaleX : scaleY;

                            if(scale>1){
                                scale=1;
                            }
                            resizeWidth = scale*resizeWidth;
                            resizeHeight = scale*resizeHeight;

                            // 이미지 중앙에 위치
                            let centerWidth = (maxWidth-resizeWidth)/2;
                            let centerHeight = (maxHeight-resizeHeight)/2;

                            if(centerWidth===0){
                                centerWidth=2;
                            }

                            if(centerHeight===0){
                                centerHeight=2;
                            }

                            window.requestFileSystem(window.TEMPORARY, 1024*1024, function (fs) {
                                fs.root.getFile('/thumbnail/'+_workListObjId+"/"+seriesId+"/"+imageId, {create: true}, function images(fileEntry) {
                                    return new Promise(resolve => {
                                        img.src = fileEntry.toURL();
                                        img.onload = () => {
                                            resolve(img);
                                        };
                                    }).then(value => {
                                        Info.Context.drawImage(value, oPos.Position.X+centerWidth, oPos.Position.Y+centerHeight, resizeWidth-2, resizeHeight-2);

                                        let seriesDesc = _thumbnail.series[oPos.Cell.seriesIdx].seriesDescription;
                                        if (seriesDesc === "hie_unknown") {
                                            seriesDesc = "-";
                                        }

                                        _this.resizeText(seriesDesc, resizeWidth);
                                        Info.Context.fillText(seriesDesc, oPos.Position.X+centerWidth, oPos.Position.Y+centerHeight);
                                    })
                                }, _this.errorHandler);
                            }, _this.errorHandler);
                        }
                        else {
                            break;
                        }
                    }
                }
            }

            /**
             * function resizeText
             * font Size 조정
             *
             * Create by 김민정 on 2018-10-22 오후 5:31
             * @param {}
             * @return {}
             **/
            resizeText(seriesDesc, resizeWidth) {
                let size = 24;

                Info.Context.beginPath();
                Info.Context.fillStyle = "white";
                Info.Context.textAlign = "left";
                Info.Context.textBaseline = "top";

                do{
                    size--;
                    Info.Context.font = "bold " + size + "px Arial";
                }while(Info.Context.measureText(seriesDesc).width>resizeWidth);
            }

            // Mouse Wheel Event Thumbnail Image
            drawWheelImages(e, nX, nY){
                for (let i in _infoSize.Position) {
                    let nL = _infoSize.Position[i].Position.X;
                    let nT = _infoSize.Position[i].Position.Y;
                    let nW = _infoSize.Position[i].Size.Width;
                    let nH = _infoSize.Position[i].Size.Height;
                    let nR = nL + nW;
                    let nB = nT + nH;

                    if (nX >= nL && nX <= nR && nY >= nT && nY <= nB) {
                        if(_infoSize.Position[i].Cell !== undefined && _infoSize.Position[i].Cell !== null){ // 이미지가 있을때
                            if (e.wheelDelta > 0) { // 휠을 올렸을때
                                let firstImgSize = _infoSize.Position[i].Cell.imgSize[0].size;
                                let firstWidth = _infoSize.Position[i].Cell.imgSize[0].width;
                                let imgIdx = _infoSize.Position[i].Cell.imageIdx;

                                // 첫번째 이미지 보다 작을 때 캔버스 클리어
                                if(firstImgSize!==_infoSize.Position[i].Cell.imgSize[imgIdx].size
                                    || firstWidth!==_infoSize.Position[i].Cell.imgSize[imgIdx].width){
                                    _this.clearCanvas();
                                }

                                _infoSize.Position[i].Cell.imageIdx -= 1;

                                if(_infoSize.Position[i].Cell.imageIdx < 0){
                                    _infoSize.Position[i].Cell.imageIdx = 0;
                                    break;
                                }
                                else {
                                    _this.drawImages();
                                }
                            }
                            else if (e.wheelDelta < 0) { // 휠을 내렸을때
                                _infoSize.Position[i].Cell.imageIdx += 1;

                                if(_infoSize.Position[i].Cell.imageIdx >= _infoSize.Position[i].Cell.lastimageIdx){
                                    _infoSize.Position[i].Cell.imageIdx = (_infoSize.Position[i].Cell.lastimageIdx-1);
                                    break;
                                }
                                else {
                                    let firstImgSize = _infoSize.Position[i].Cell.imgSize[0].size;
                                    let firstWidth = _infoSize.Position[i].Cell.imgSize[0].width;
                                    let imgIdx = _infoSize.Position[i].Cell.imageIdx;

                                    // 첫번째 이미지 보다 작을 때 캔버스 클리어
                                    if(firstImgSize!==_infoSize.Position[i].Cell.imgSize[imgIdx].size
                                        || firstWidth!==_infoSize.Position[i].Cell.imgSize[imgIdx].width){
                                        _this.clearCanvas();
                                    }
                                    _this.drawImages();
                                }
                            }
                        } // if
                    } // if
                } // for
            }

            setSelectCellBounds() {

                if (Info.Width < 1 || Info.Height < 1) {
                    return;
                }

                if (Info.EditMode !== e_EditMode_SelectCell) {
                    return;
                }

                let nStartCellX = Info.SelectCell.PaddingWidth;
                let nStartCellY = Info.SelectCell.PaddingWidth;

                let nRow = Info.SelectCell.Rows;
                let nCol = Info.SelectCell.Columns;

                let nOneWidth = parseInt(Info.Width / nCol)+nStartCellX;
                let nOneHeight = parseInt(Info.Height / nRow)+nStartCellY;

                Info.SelectCell.Cells = [];
                Info.SelectCell.SelectedRow = -1;
                Info.SelectCell.SelectedColumn = -1;
                Info.SelectCell.SelectedIndex = -1;

                for (let i = 0; i < nRow; i++) {
                    for (let j = 0; j < nCol; j++) {

                        let cellInfo = {};
                        cellInfo.Row = i;
                        cellInfo.Col = j;
                        cellInfo.CellStyle = e_CellStyle_None;

                        let nX = (cellInfo.Col * nOneWidth);
                        let nY = (cellInfo.Row * nOneHeight);

                        cellInfo.Position = _this.newPoint(nX, nY);
                        cellInfo.Size = _this.newSize(nOneWidth, nOneHeight);

                        Info.SelectCell.Cells.push(cellInfo);
                    }// for j
                }// for i
            }

            setSetPositionCellBounds() {

                if (Info.Width < 1 || Info.Height < 1) {
                    return;
                }

                if (Info.EditMode !== e_EditMode_SetPosition) {
                    return;
                }

                let nStartCellX = Info.SetPosition.PaddingWidth;
                let nStartCellY = Info.SetPosition.PaddingWidth;

                Info.SetPosition.Cells = [];

                let nRow = Info.SetPosition.Rows;
                let nCol = Info.SetPosition.Columns;

                let nWholeWidth = Info.Width - (Info.SetPosition.PaddingWidth * 2);
                let nWholeHeight = Info.Height - Info.SetPosition.PaddingWidth - nStartCellY;

                let nOneWidth = parseInt(nWholeWidth / nCol);
                let nOneHeight = parseInt(nWholeHeight / nRow);

                for (let i = 0; i < nRow; i++) {
                    for (let j = 0; j < nCol; j++) {

                        let cellInfo = {};
                        cellInfo.Row = i;
                        cellInfo.Col = j;

                        let nX = (cellInfo.Col * nOneWidth) + nStartCellX;
                        let nY = (cellInfo.Row * nOneHeight) + nStartCellY;

                        cellInfo.Position = _this.newPoint(nX, nY);
                        cellInfo.Size = _this.newSize(nOneWidth, nOneHeight);

                        Info.SetPosition.Cells.push(cellInfo);
                    }// for j
                }// for i
            }

            GetButtonsHeight() {

                let nHeight = 0;

                for (let i = 0; i < Info.SetPosition.Buttons.length; i++) {

                    if (nHeight < Info.SetPosition.Buttons[i].Size.Height) {
                        nHeight = Info.SetPosition.Buttons[i].Size.Height;
                    }// if

                }// for i

                return nHeight;
            }

            newPoint(nX, nY) {
                let Point = {};
                Point.X = nX;
                Point.Y = nY;

                return Point;
            }

            newSize(nWidth, nHeight) {
                let Size = {};
                Size.Width = nWidth;
                Size.Height = nHeight;

                return Size;
            }

            OnMouseMove(e) {

                let canvas = _this.$.canvasImages;
                let bound = canvas.getBoundingClientRect();
                let bw = 5;

                let nX = (e.x - bound.left - bw) * (canvas.offsetWidth / (bound.width - bw * 2));
                let nY = (e.y - bound.top - bw) * (canvas.offsetHeight / (bound.height - bw * 2));

                // let nX = e.x - e.target.offsetLeft;
                // let nY = e.y - e.target.offsetTop;
                let nBtn = e.buttons;

                if (Info.EditMode === e_EditMode_SelectCell) {

                    _this.SetMouseMove_SelectCell(nX, nY, nBtn);

                }
                else {
                    // drag
                    _this.SetMouseMove_SetPosition(nX, nY, nBtn);
                }
            }

            OnMouseDown(e) {
                // let nX = e.x - e.target.offsetLeft;
                // let nY = e.y - e.target.offsetTop;

                let canvas = _this.$.canvasImages;
                let bound = canvas.getBoundingClientRect();
                let bw = 5;

                let nX = (e.x - bound.left - bw) * (canvas.offsetWidth / (bound.width - bw * 2));
                let nY = (e.y - bound.top - bw) * (canvas.offsetHeight / (bound.height - bw * 2));
                let nBtn = e.buttons;

                if (Info.EditMode === e_EditMode_SelectCell) {
                    // layout 설정
                    _this.SetMouseDown_SelectCell(nX, nY, nBtn);

                    if(_thumbnail.series !== undefined) {
                        // layout 설정 후 썸네일 이미지 Redraw
                        _this.seriesPagingClear();
                        _this.setCellThumbnail(_thumbnail);
                    }
                }
                else if (Info.EditMode === e_EditMode_SetPosition) {
                    // _this.SetMouseDown_SetPosition(nX, nY, nBtn);
                }
            }

            OnMouseUp(e) {
                // let nX = e.x - e.target.offsetLeft;
                // let nY = e.y - e.target.offsetTop;

                let canvas = _this.$.canvasImages;
                let bound = canvas.getBoundingClientRect();
                let bw = 5;

                let nX = (e.x - bound.left - bw) * (canvas.offsetWidth / (bound.width - bw * 2));
                let nY = (e.y - bound.top - bw) * (canvas.offsetHeight / (bound.height - bw * 2));
                let nBtn = e.buttons;

                if (Info.EditMode === e_EditMode_SelectCell) {
                }
                else if (Info.EditMode === e_EditMode_SetPosition) {
                    //_this.SetMouseUp_SetPosition(nX, nY, nBtn);
                }
            }

            OnMouseWheel(e) {
                // let nX = e.x - e.target.offsetLeft;
                // let nY = e.y - e.target.offsetTop;

                let canvas = _this.$.canvasImages;
                let bound = canvas.getBoundingClientRect();
                let bw = 5;

                let nX = (e.x - bound.left - bw) * (canvas.offsetWidth / (bound.width - bw * 2));
                let nY = (e.y - bound.top - bw) * (canvas.offsetHeight / (bound.height - bw * 2));

                // console.log(bound);

                _this.drawWheelImages(e, nX, nY);
            }

            SetMouseMove_SelectCell(nX, nY, nBtn) {

                let bRedraw = false;
                let bMatch = false;
                let nSelIndex = Info.SelectCell.SelectedIndex;

                if (nSelIndex > -1 && Info.SelectCell.Cells.length > nSelIndex) {
                    let nL = Info.SelectCell.Cells[nSelIndex].Position.X;
                    let nT = Info.SelectCell.Cells[nSelIndex].Position.Y;
                    let nW = Info.SelectCell.Cells[nSelIndex].Size.Width;
                    let nH = Info.SelectCell.Cells[nSelIndex].Size.Height;
                    let nR = nL + nW;
                    let nB = nT + nH;

                    if (nX >= nL && nX <= nR && nY >= nT && nY <= nB) {
                        bMatch = true;
                    }// if
                }

                if (!bMatch) {
                    Info.SelectCell.SelectedIndex = -1;
                    Info.SelectCell.SelectedRow = -1;
                    Info.SelectCell.SelectedColumn = -1;

                    // console.log(Info.SelectCell.SelectedIndex);

                    for (let i = 0; i < Info.SelectCell.Cells.length; i++) {

                        let nL = Info.SelectCell.Cells[i].Position.X;
                        let nT = Info.SelectCell.Cells[i].Position.Y;
                        let nW = Info.SelectCell.Cells[i].Size.Width;
                        let nH = Info.SelectCell.Cells[i].Size.Height;
                        let nR = nL + nW;
                        let nB = nT + nH;

                        if (nX >= nL && nX <= nR && nY >= nT && nY <= nB) {

                            Info.SelectCell.SelectedIndex = i;
                            Info.SelectCell.SelectedRow = Info.SelectCell.Cells[i].Row;
                            Info.SelectCell.SelectedColumn = Info.SelectCell.Cells[i].Col;

                            let nSelCol = Info.SelectCell.SelectedColumn;
                            let nSelRow = Info.SelectCell.SelectedRow;

                            bMatch = true;
                            bRedraw = true;

                            for (let j = 0; j < Info.SelectCell.Cells.length; j++) {
                                let nCol = Info.SelectCell.Cells[j].Col;
                                let nRow = Info.SelectCell.Cells[j].Row;

                                if (nCol <= nSelCol && nRow <= nSelRow) {
                                    Info.SelectCell.Cells[j].Include = true;
                                }
                                else {
                                    Info.SelectCell.Cells[j].Include = false;
                                }
                            }// for j

                            break;
                        }// if
                    }// for i

                }// if

                if (bRedraw) {
                    _this.drawBoard();
                }
            }

            SetMouseMove_SetPosition(nX, nY, nBtn) {
                // if (nBtn === 1) {
                let bRedraw = false;
                let bMatch = false;
                let nSelIndex = Info.MouseDragCellIndex;

                if (nSelIndex > -1 && Info.SetPosition.Cells.length > nSelIndex) {
                    let nL = Info.SetPosition.Cells[nSelIndex].Position.X;
                    let nT = Info.SetPosition.Cells[nSelIndex].Position.Y;
                    let nW = Info.SetPosition.Cells[nSelIndex].Size.Width;
                    let nH = Info.SetPosition.Cells[nSelIndex].Size.Height;
                    let nR = nL + nW;
                    let nB = nT + nH;

                    if (nX >= nL && nX <= nR && nY >= nT && nY <= nB) {

                        bMatch = true;
                    }// if
                }

                if (!bMatch) {
                    for (let i = 0; i < Info.SetPosition.Cells.length; i++) {

                        let nL = Info.SetPosition.Cells[i].Position.X;
                        let nT = Info.SetPosition.Cells[i].Position.Y;
                        let nW = Info.SetPosition.Cells[i].Size.Width;
                        let nH = Info.SetPosition.Cells[i].Size.Height;
                        let nR = nL + nW;
                        let nB = nT + nH;

                        // Info.MouseDragCellIndex = i;
                        // console.log(Info.MouseDragCellIndex);

                        if (nX >= nL && nX <= nR && nY >= nT && nY <= nB) {
                            Info.MouseDragCellIndex = i;
                            // console.log(nL, nT, nW, nH);
                            // console.log(Info.MouseDragCellIndex);
                            //
                            // if (Info.SetPosition.Drags.includes(i)) {
                            //     for (let j = Info.SetPosition.Drags.length - 1; j >= 0; j--) {
                            //         let nIndex = Info.SetPosition.Drags[j];
                            //
                            //         if (nIndex === i) {
                            //             break;
                            //         }
                            //         else {
                            //             Info.SetPosition.Drags.pop();
                            //         }
                            //     }
                            // }
                            // else {
                            //     Info.SetPosition.Drags.push(i);
                            // }
                            //
                            bMatch = true;
                            // bRedraw = true;
                            //
                            // break;
                        }// if
                    }// for i

                }// if

                if (bRedraw) {
                    _this.drawBoard();
                }

                // }// if (nBtn == 1)
            }

            SetMouseDown_SelectCell(nX, nY, nBtn) {
                if (nBtn === 1) {
                    _this.SetMouseMove_SelectCell(nX, nY, nBtn);

                    if (Info.SelectCell.SelectedRow > -1 && Info.SelectCell.SelectedColumn > -1) {

                        // let sMsg = "Select : ".concat(Info.SelectCell.SelectedRow + 1, "X", Info.SelectCell.SelectedColumn + 1);
                        // alert(sMsg);

                        Info.EditMode = e_EditMode_SetPosition;
                        Info.SetPosition.Rows = Info.SelectCell.SelectedRow + 1;
                        Info.SetPosition.Columns = Info.SelectCell.SelectedColumn + 1;
                        _this.setSetPositionCellBounds();
                        _this.drawBoard();
                    }
                }// if
            }

            SetMouseDown_SetPosition(nX, nY, nBtn) {
                if (nBtn === 1) {

                    // Info.SetPosition.Drags = [];
                    let bMatch = false;

                    for (let i = 0; i < Info.SetPosition.Buttons.length; i++) {
                        let oBtn = Info.SetPosition.Buttons[i];

                        let nL = Info.SetPosition.Buttons[i].Position.X;
                        let nT = Info.SetPosition.Buttons[i].Position.Y;
                        let nW = Info.SetPosition.Buttons[i].Size.Width;
                        let nH = Info.SetPosition.Buttons[i].Size.Height;
                        let nR = nL + nW;
                        let nB = nT + nH;

                        if (nX >= nL && nX <= nR && nY >= nT && nY <= nB) {

                            if (oBtn.Style === e_Button_Radio) {
                                _this.setSetPositionCheck(oBtn.Command);
                                _this.drawBoard();
                            }
                            else {
                                _this.setSetPositionClear();
                            }

                            bMatch = true;
                            break;
                        }// if
                    }// for i

                    if (!bMatch) {
                        for (let i = 0; i < Info.SetPosition.Cells.length; i++) {
                            let oCell = Info.SetPosition.Cells[i];

                            let nL = oCell.Position.X;
                            let nT = oCell.Position.Y;
                            let nW = oCell.Size.Width;
                            let nH = oCell.Size.Height;
                            let nR = nL + nW;
                            let nB = nT + nH;

                            if (nX >= nL && nX <= nR && nY >= nT && nY <= nB) {
                                // Info.SetPosition.Drags.push(i);
                                Info.MouseDragCellIndex = i;

                                //if (oCell.Command != Info.SetPosition.Command) {

                                //    oCell.Command = "";
                                //    oCell.SortNo = 0;

                                //    var nSeq = GetMaxSortNo(Info.SetPosition.Command) + 1;

                                //    oCell.Command = Info.SetPosition.Command;
                                //    oCell.SortNo = nSeq;

                                //}// if

                                _this.drawBoard();

                                bMatch = true;
                                break;
                            }// if
                        }// for i
                    }
                }// if
            }

            SetMouseUp_SetPosition(nX, nY, nBtn) {

                // if (Info.SetPosition.Drags.length) {
                //
                //     for (let i = 0; i < Info.SetPosition.Drags.length; i++) {
                //         let nIndex = Info.SetPosition.Drags[i];
                //
                //         if (Info.SetPosition.Cells[nIndex].Command !== Info.SetPosition.Command)
                //         {
                //             let nSeq = _this.GetMaxSortNo(Info.SetPosition.Command) + 1;
                //
                //             Info.SetPosition.Cells[nIndex].Command = Info.SetPosition.Command;
                //             Info.SetPosition.Cells[nIndex].SortNo = nSeq;
                //         }
                //     }// for i
                //
                //     Info.SetPosition.Drags = [];
                //     _this.drawBoard();
                // }//if

            }

            GetMaxSortNo(sCommand) {

                let asCommands = ["NEW", "OLD", "FIRST"];
                let obj = [];

                for (let i = 0; i < asCommands.length; i++) {
                    obj[asCommands[i]] = [];
                }

                for (let i = 0; i < Info.SetPosition.Cells.length; i++) {

                    let oCell = Info.SetPosition.Cells[i];

                    if (oCell.Command !== undefined &&  oCell.Command !== "") {
                        obj[oCell.Command].push("".concat(oCell.SortNo.toString().padLeft(2, "0"), ",", i));
                    }// if

                }// for i

                for (let i = 0; i < asCommands.length; i++) {
                    obj[asCommands[i]].sort();
                }

                for (let i = 0; i < asCommands.length; i++) {
                    for (let j = 0; j < obj[asCommands[i]].length; j++) {

                        let sCell = obj[asCommands[i]][j];
                        let asCell = sCell.split(",");
                        let nCellIndex = parseInt(asCell[1]);

                        Info.SetPosition.Cells[nCellIndex].SortNo = j + 1;

                    }// for j
                }// for i

                return obj[sCommand].length;
            }// if

            nextImages() {
                if(_nextImage){
                    _prevImage = true;

                    let nPos = 0;

                    // 셀 갯수
                    let nCellLen = _infoSize.Position.length;
                    // 총 시리즈 갯수
                    let nSeriesLen = _arrImage.length - 1;

                    for(let i in _infoSize.Position) {

                        // 다음 페이지에서 시작되는 시리즈 index
                        let nextSeries = _nextIdx+nCellLen;

                        if(nextSeries === nSeriesLen){
                            _nextImage = false;
                        }

                        if (nSeriesLen >= nextSeries) {
                            _infoSize.Position[nPos].Cell = _arrImage[nextSeries];
                        }
                        else {
                            _nextImage = false;
                            _infoSize.Position[nPos].Cell = null;
                        }

                        nPos++;
                        _nextIdx++;

                    }

                    _this.clearCanvas();
                    _this.drawImages();

                } // if
            }

            prevImages() {
                if(_prevImage){

                    let nSeriesLen = _arrImage.length;
                    let nCellLen = _infoSize.Position.length;
                    let emptySeries = nSeriesLen-nCellLen;

                    // 코드 1391번 줄에서 증가를 하고  루프문에서 빠져나오기 때문에 -1을 해줘야함
                    _nextIdx-=1;

                    // 남은 시리즈가 있는지 확인
                    if(emptySeries > 0) {
                        nSeriesLen =  nSeriesLen-emptySeries-1;
                        _nextImage = true;
                    }
                    else {
                        _prevImage = false;
                    }

                    for(let nPos in _infoSize.Position) {

                        if(_nextIdx >= 0) {
                            _infoSize.Position[nSeriesLen-parseInt(nPos)].Cell = _arrImage[_nextIdx];
                        }
                        else {
                            _prevImage = false;
                            break;
                        }

                        _nextIdx--;

                    }

                    _this.clearCanvas();
                    _this.drawImages();

                    // 코드 1432번 줄에서 감소를 하고  루프문에서 빠져나오기 때문에 +1을 해줘야함
                    _nextIdx+=1;

                } // if
            }

            /**
             * function getThumbnailCell
             * Thumbnail 설정버튼 클릭 유무 확인
             *
             * Create by 김민정 on 2018-05-17 오후 3:57
             * @param {Boolean} checkSet
             * @return {Boolean} checkSet
             **/
            getThumbnailCell(checkSet) {
                _checkThumbnailCell = checkSet;
            }

            /**
             * function setThumbnailCell
             * Thumbnail 설정버튼 이벤트
             *
             * Create by 김민정 on 2018-12-06 오전 9:57
             * @param {}
             * @return {}
             **/
            setThumbnailCell() {
                _thumbnailCell = true;

                let param = new Object();
                param.detail = _thumbnailCell;

                _this.getThumbnailCell(param.detail);
                _this.startBody();

                param.detail = false;
                _this.getThumbnailCell(param.detail);
            }
        }

        window.customElements.define(HhThumbnail.is, HhThumbnail);
    })();
  </script>
</dom-module>
